const allowedOrigins = [
  "https://g-1-f29l.vercel.app",
  "https://airtable-proxy-sand.vercel.app"
];

export default async function handler(req, res) {
  const origin = req.headers.origin;

  if (allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
  } else {
    res.setHeader("Access-Control-Allow-Origin", allowedOrigins[0]);
  }

  res.setHeader("Vary", "Origin");
  res.setHeader("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Authorization");
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  const API_KEY = process.env.AIRTABLE_API_KEY;
  const BASE_ID = "appcVDsCi9eYi3UNk";
  const TABLE_NAME = "상담신청";

  if (!API_KEY || !BASE_ID || !TABLE_NAME) {
    return res.status(500).json({ error: "Airtable 환경변수 설정 필요", code: "NO_ENV" });
  }

  const AIRTABLE_API_URL = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`;

  if (req.method === "POST") {
    try {
      const allowedFields = ["날짜", "성함", "전화번호", "상담 예약 시간"];
      const body = req.body;
      const fields = {};
      for (const key of allowedFields) {
        if (body[key] !== undefined) fields[key] = body[key];
      }

      const airtableRes = await fetch(AIRTABLE_API_URL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${API_KEY}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ fields }),
      });

      const data = await airtableRes.json();
      if (!airtableRes.ok) throw data;

      return res.status(200).json(data);

    } catch (e) {
      console.error("API /api/submit POST error:", e);
      return res.status(500).json({ error: e.message || "Internal Error" });
    }
  }

  if (req.method === "GET") {
    try {
      const airtableRes = await fetch(AIRTABLE_API_URL, {
        headers: {
          Authorization: `Bearer ${API_KEY}`,
        },
      });
      const data = await airtableRes.json();
      return res.status(200).json(data);
    } catch (e) {
      console.error("API /api/submit GET error:", e);
      return res.status(500).json({ error: e.message || "Internal Error" });
    }
  }

  return res.status(405).json({ error: "허용되지 않는 요청", code: "METHOD_NOT_ALLOWED" });
}
